<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - Matcha</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #f5f5f5;
        }
        
        .profile-setup {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 2rem;
        }
        
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .form-section:last-of-type {
            border-bottom: none;
        }
        
        .form-section h2 {
            color: #444;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .radio-label, .checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.7rem 1.2rem;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .radio-label:hover, .checkbox-label:hover {
            background-color: #e0e0e0;
        }
        
        .radio-label input, .checkbox-label input {
            margin-right: 0.5rem;
        }
        
        .radio-label input:checked + span,
        .checkbox-label input:checked + span {
            font-weight: bold;
        }
        
        .radio-label:has(input:checked),
        .checkbox-label:has(input:checked) {
            background-color: #e3f2fd;
            border: 2px solid #2196F3;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }
        
        .tag-label {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .tag-label:hover {
            background-color: #e0e0e0;
        }
        
        .tag-label input {
            display: none;
        }
        
        .tag-label:has(input:checked) {
            background-color: #4CAF50;
            color: white;
        }
        
        .tag-text::before {
            content: '#';
            opacity: 0.7;
        }
        
        .photos-section {
            margin-bottom: 1rem;
        }
        
        .photo-upload-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .photo-input-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .photo-preview {
            width: 120px;
            height: 120px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #fafafa;
        }
        
        .photo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .photo-preview.has-image {
            border-style: solid;
            border-color: #4CAF50;
        }
        
        .profile-photo-radio {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            padding: 0.4rem 0.8rem;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .upload-btn:hover {
            background-color: #1976D2;
        }
        
        .submit-btn {
            width: 100%;
            padding: 1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .submit-btn:hover {
            background-color: #43A047;
        }
        
        .info-text {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }
        
        .required {
            color: #f44336;
        }
        
        /* Location section styles */
        .location-section {
            margin-bottom: 1rem;
        }
        
        .location-consent-box {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .location-consent-box h3 {
            margin: 0 0 0.75rem 0;
            color: #1976D2;
            font-size: 1rem;
        }
        
        .location-consent-box p {
            margin: 0 0 1rem 0;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }
        
        .consent-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .consent-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.2s;
        }
        
        .consent-btn.allow {
            background-color: #4CAF50;
            color: white;
        }
        
        .consent-btn.allow:hover {
            background-color: #43A047;
        }
        
        .consent-btn.deny {
            background-color: #9e9e9e;
            color: white;
        }
        
        .consent-btn.deny:hover {
            background-color: #757575;
        }
        
        .location-result {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .location-result.success {
            background-color: #e8f5e9;
            border: 1px solid #4CAF50;
            color: #2e7d32;
            display: block;
        }
        
        .location-result.error {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            display: block;
        }
        
        .manual-location {
            margin-top: 1rem;
            display: none;
        }
        
        .manual-location.visible {
            display: block;
        }
        
        .manual-location-row {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
        }
        
        .manual-location-row .form-group {
            flex: 1;
        }
        
        .manual-location-row label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
        }
        
        .manual-location-row input,
        .manual-location-row select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95rem;
        }
        
        .manual-location-row input:focus,
        .manual-location-row select:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .manual-location-row input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        
        .rgpd-notice {
            font-size: 0.8rem;
            color: #888;
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .rgpd-notice a {
            color: #2196F3;
        }
        
        /* City Autocomplete Styles */
        .autocomplete-wrapper {
            position: relative;
        }
        
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-results.visible {
            display: block;
        }
        
        .autocomplete-item {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #e3f2fd;
        }
        
        .autocomplete-item .city-name {
            font-weight: bold;
            color: #333;
        }
        
        .autocomplete-item .city-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .autocomplete-loading {
            padding: 0.6rem;
            text-align: center;
            color: #888;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="profile-setup">
        <h1>Complete Your Profile</h1>
        <p class="subtitle">Welcome <%= email %>! Tell us about yourself to find your perfect match.</p>
        
        <form action="/profile/setup" method="POST" enctype="multipart/form-data" id="profileForm">
            
            <!-- Gender Section -->
            <div class="form-section">
                <h2>Your Gender <span class="required">*</span></h2>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="gender" value="male" required>
                        <span>Male</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="gender" value="female" required>
                        <span>Female</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="gender" value="other" required>
                        <span>Other</span>
                    </label>
                </div>
            </div>
            
            <!-- Sexual Preference Section -->
            <div class="form-section">
                <h2>Interested In <span class="required">*</span></h2>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="sexual_preference" value="male" required>
                        <span>Men</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="sexual_preference" value="female" required>
                        <span>Women</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="sexual_preference" value="other" required>
                        <span>Other</span>
                    </label>
                </div>
            </div>
            
            <!-- Biography Section -->
            <div class="form-section">
                <h2>About You <span class="required">*</span></h2>
                <p class="info-text">Write a short bio to let others know who you are.</p>
                <textarea name="biography" placeholder="Tell us about yourself, your hobbies, what you're looking for..." required></textarea>
            </div>
            
            <!-- Interests/Tags Section -->
            <div class="form-section">
                <h2>Your Interests <span class="required">*</span></h2>
                <p class="info-text">Select at least one tag that describes your interests.</p>
                <div class="tags-container">
                    <%= tagsHtml %>
                </div>
            </div>
            
            <!-- Location Section (RGPD Compliant) -->
            <div class="form-section location-section">
                <h2>Your Location <span class="required">*</span></h2>
                
                <div class="location-consent-box">
                    <h3>We need your location to find matches near you</h3>
                    <p>
                        We only store your city and country to show you relevant matches nearby. 
                        Your precise location (GPS coordinates) is never shared with other users.
                        You can update or remove your location at any time in your profile settings.
                    </p>
                    <div class="consent-buttons">
                        <button type="button" class="consent-btn allow" onclick="requestGeolocation()">
                            Allow automatic location
                        </button>
                        <button type="button" class="consent-btn deny" onclick="showManualLocation()">
                            Enter location manually
                        </button>
                    </div>
                </div>
                
                <div class="location-result" id="locationResult"></div>
                
                <div class="manual-location" id="manualLocation">
                    <p class="info-text">Select your country, then enter your city:</p>
                    <div class="manual-location-row">
                        <div class="form-group">
                            <label for="locationCountryInput">Country</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="locationCountryInput" placeholder="Type your country..." autocomplete="off">
                                <div class="autocomplete-results" id="countryAutocomplete"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="locationCity">City</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="locationCity" name="location_city" placeholder="Select a country first..." autocomplete="off" disabled>
                                <div class="autocomplete-results" id="cityAutocomplete"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden fields for geolocation data -->
                <input type="hidden" id="locationLatitude" name="location_latitude">
                <input type="hidden" id="locationLongitude" name="location_longitude">
                <input type="hidden" id="locationCountryName" name="location_country">
                <input type="hidden" id="locationConsent" name="location_consent" value="false">
                <input type="hidden" id="locationManual" name="location_manual" value="false">
                
                <p class="rgpd-notice">
                    In accordance with GDPR/RGPD, you have the right to access, modify, or delete your location data at any time.
                    Your data is processed only to provide you with relevant matches and is never sold to third parties.
                </p>
            </div>
            
            <!-- Photos Section -->
            <div class="form-section">
                <h2>Your Photos <span class="required">*</span></h2>
                <p class="info-text">Upload at least one photo (up to 5). Select one as your profile picture.</p>
                
                <div class="photo-upload-container" id="photoContainer">
                    <!-- Photo slots will be generated by JavaScript -->
                </div>
                
                <input type="hidden" name="profile_photo_index" id="profilePhotoIndex" value="0">
            </div>
            
            <button type="submit" class="submit-btn">Complete Profile</button>
        </form>
    </div>
    
    <script>
        // Generate 5 photo upload slots
        const photoContainer = document.getElementById('photoContainer');
        const profilePhotoIndex = document.getElementById('profilePhotoIndex');
        
        for (let i = 0; i < 5; i++) {
            const wrapper = document.createElement('div');
            wrapper.className = 'photo-input-wrapper';
            wrapper.innerHTML = `
                <div class="photo-preview" id="preview${i}">
                    <span style="color: #999;">Photo ${i + 1}</span>
                </div>
                <input type="file" name="photos" class="file-input" id="photo${i}" accept="image/jpeg,image/png" onchange="previewImage(this, ${i})">
                <button type="button" class="upload-btn" onclick="document.getElementById('photo${i}').click()">Choose</button>
                <label class="profile-photo-radio">
                    <input type="radio" name="profile_photo_select" value="${i}" ${i === 0 ? 'checked' : ''} onchange="updateProfilePhotoIndex(${i})">
                    <span>Profile Photo</span>
                </label>
            `;
            photoContainer.appendChild(wrapper);
        }
        
        function previewImage(input, index) {
            const preview = document.getElementById('preview' + index);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Photo ${index + 1}">`;
                    preview.classList.add('has-image');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function updateProfilePhotoIndex(index) {
            profilePhotoIndex.value = index;
        }

        // Form validation
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            // Check if at least one photo is uploaded
            const photoInputs = document.querySelectorAll('input[name="photos"]');
            let hasPhoto = false;
            photoInputs.forEach(input => {
                if (input.files && input.files.length > 0) {
                    hasPhoto = true;
                }
            });
            
            if (!hasPhoto) {
                e.preventDefault();
                alert('Please upload at least one photo');
                return;
            }

            // Check if at least one tag is selected
            const tagInputs = document.querySelectorAll('input[name="tags"]:checked');
            if (tagInputs.length === 0) {
                e.preventDefault();
                alert('Please select at least one interest tag');
                return;
            }
            
            // Check if location is provided
            const locationCity = document.getElementById('locationCity').value;
            const locationCountryInput = document.getElementById('locationCountryInput').value;
            const locationConsent = document.getElementById('locationConsent').value;
            
            if (!locationCity || !locationCountryInput) {
                e.preventDefault();
                alert('Please provide your location (either automatically or manually)');
                return;
            }
        });
        
        // Geolocation functions
        function requestGeolocation() {
            const resultDiv = document.getElementById('locationResult');
            resultDiv.className = 'location-result';
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Requesting location...';
            
            if (!navigator.geolocation) {
                resultDiv.className = 'location-result error';
                resultDiv.textContent = 'Geolocation is not supported by your browser. Please enter your location manually.';
                showManualLocation();
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Store coordinates
                    document.getElementById('locationLatitude').value = lat;
                    document.getElementById('locationLongitude').value = lon;
                    document.getElementById('locationConsent').value = 'true';
                    document.getElementById('locationManual').value = 'false';
                    
                    // Reverse geocode to get city/country
                    try {
                        const response = await fetch(`/profile/api/reverse-geocode?lat=${lat}&lon=${lon}`);
                        const data = await response.json();
                        
                        if (data.city && data.country) {
                            // Display suburb + city if suburb is available (precision "jusqu'au quartier")
                            const displayLocation = data.suburb 
                                ? `${data.suburb}, ${data.city}` 
                                : data.city;
                            
                            document.getElementById('locationCity').value = displayLocation;
                            document.getElementById('locationCountryName').value = data.country;
                            
                            // Set country in text input
                            document.getElementById('locationCountryInput').value = data.country;
                            document.getElementById('locationCity').disabled = false;
                            
                            resultDiv.className = 'location-result success';
                            resultDiv.textContent = `Location detected: ${displayLocation}, ${data.country}`;
                            
                            // Hide manual input since we got the location
                            document.getElementById('manualLocation').classList.remove('visible');
                        } else {
                            throw new Error('Could not determine city/country');
                        }
                    } catch (error) {
                        console.error('Reverse geocoding error:', error);
                        resultDiv.className = 'location-result error';
                        resultDiv.textContent = 'Could not determine your city. Please enter it manually.';
                        showManualLocation();
                    }
                },
                async (error) => {
                    console.error('Geolocation error:', error);
                    resultDiv.className = 'location-result error';
                    
                    let message = 'Could not get your location. ';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'You denied the request. Please enter your location manually.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Location information is unavailable. Please enter manually.';
                            break;
                        case error.TIMEOUT:
                            message += 'The request timed out. Please enter manually.';
                            break;
                        default:
                            message += 'Please enter your location manually.';
                    }
                    
                    resultDiv.textContent = message;
                    showManualLocation();
                },
                {
                    enableHighAccuracy: false,
                    timeout: 30000,
                    maximumAge: 300000
                }
            );
        }
        
        function showManualLocation() {
            document.getElementById('manualLocation').classList.add('visible');
            document.getElementById('locationManual').value = 'true';
            document.getElementById('locationConsent').value = 'false';
            document.getElementById('locationLatitude').value = '';
            document.getElementById('locationLongitude').value = '';
        }
        
        // Country and City Autocomplete functionality
        (function() {
            const countryInput = document.getElementById('locationCountryInput');
            const countryAutocomplete = document.getElementById('countryAutocomplete');
            const cityInput = document.getElementById('locationCity');
            const cityAutocomplete = document.getElementById('cityAutocomplete');
            const latitudeInput = document.getElementById('locationLatitude');
            const longitudeInput = document.getElementById('locationLongitude');
            
            let countryDebounce = null;
            let cityDebounce = null;
            let selectedCountryIndex = -1;
            let selectedCityIndex = -1;
            let countrySuggestions = [];
            let citySuggestions = [];
            let selectedCountryName = '';
            
            function searchCountries(query) {
                if (countryDebounce) clearTimeout(countryDebounce);
                
                if (query.length < 1) {
                    hideCountryAutocomplete();
                    return;
                }
                
                countryAutocomplete.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
                countryAutocomplete.classList.add('visible');
                
                countryDebounce = setTimeout(async () => {
                    try {
                        const response = await fetch(`/profile/api/country-autocomplete?q=${encodeURIComponent(query)}`);
                        const suggestions = await response.json();
                        
                        countrySuggestions = suggestions;
                        selectedCountryIndex = -1;
                        
                        if (suggestions.length === 0) {
                            countryAutocomplete.innerHTML = '<div class="autocomplete-loading">No countries found</div>';
                            return;
                        }
                        
                        countryAutocomplete.innerHTML = suggestions.map((item, index) => `
                            <div class="autocomplete-item" data-index="${index}">
                                <span class="city-name">${item.name}</span>
                            </div>
                        `).join('');
                        
                    } catch (error) {
                        console.error('Country autocomplete error:', error);
                        countryAutocomplete.innerHTML = '<div class="autocomplete-loading">Error loading suggestions</div>';
                    }
                }, 200);
            }
            
            function selectCountry(index) {
                const country = countrySuggestions[index];
                if (country) {
                    countryInput.value = country.name;
                    selectedCountryName = country.name;
                    hideCountryAutocomplete();
                    
                    // Enable city input
                    cityInput.disabled = false;
                    cityInput.placeholder = `Type a city in ${country.name}...`;
                    cityInput.value = '';
                    cityInput.focus();
                    
                    // Clear previous city data
                    latitudeInput.value = '';
                    longitudeInput.value = '';
                }
            }
            
            function hideCountryAutocomplete() {
                countryAutocomplete.classList.remove('visible');
                countryAutocomplete.innerHTML = '';
                countrySuggestions = [];
                selectedCountryIndex = -1;
            }
            
            countryInput.addEventListener('input', (e) => {
                // Reset country selection if user types after selecting
                if (selectedCountryName && e.target.value !== selectedCountryName) {
                    selectedCountryName = '';
                    cityInput.disabled = true;
                    cityInput.placeholder = 'Select a country first...';
                    cityInput.value = '';
                }
                searchCountries(e.target.value);
            });
            
            countryInput.addEventListener('keydown', (e) => {
                const items = countryAutocomplete.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedCountryIndex = Math.min(selectedCountryIndex + 1, items.length - 1);
                    updateCountrySelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedCountryIndex = Math.max(selectedCountryIndex - 1, 0);
                    updateCountrySelection(items);
                } else if (e.key === 'Enter' && selectedCountryIndex >= 0) {
                    e.preventDefault();
                    selectCountry(selectedCountryIndex);
                } else if (e.key === 'Escape') {
                    hideCountryAutocomplete();
                }
            });
            
            function updateCountrySelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedCountryIndex);
                });
                if (selectedCountryIndex >= 0 && items[selectedCountryIndex]) {
                    items[selectedCountryIndex].scrollIntoView({ block: 'nearest' });
                }
            }
            
            countryAutocomplete.addEventListener('click', (e) => {
                const item = e.target.closest('.autocomplete-item');
                if (item) {
                    selectCountry(parseInt(item.dataset.index));
                }
            });
            
            function searchCities(query) {
                if (cityDebounce) clearTimeout(cityDebounce);
                
                if (query.length < 2) {
                    hideCityAutocomplete();
                    return;
                }
                
                cityAutocomplete.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
                cityAutocomplete.classList.add('visible');
                
                cityDebounce = setTimeout(async () => {
                    try {
                        const url = `/profile/api/city-autocomplete?q=${encodeURIComponent(query)}&countryName=${encodeURIComponent(selectedCountryName)}`;
                        const response = await fetch(url);
                        const suggestions = await response.json();
                        
                        citySuggestions = suggestions;
                        selectedCityIndex = -1;
                        
                        if (suggestions.length === 0) {
                            cityAutocomplete.innerHTML = '<div class="autocomplete-loading">No cities found</div>';
                            return;
                        }
                        
                        cityAutocomplete.innerHTML = suggestions.map((item, index) => `
                            <div class="autocomplete-item" data-index="${index}">
                                <span class="city-name">${item.city}</span>
                                <span class="city-details">${item.postcode || ''}</span>
                            </div>
                        `).join('');
                        
                    } catch (error) {
                        console.error('City autocomplete error:', error);
                        cityAutocomplete.innerHTML = '<div class="autocomplete-loading">Error loading suggestions</div>';
                    }
                }, 300);
            }
            
            function selectCity(index) {
                const city = citySuggestions[index];
                if (city) {
                    cityInput.value = city.city;
                    document.getElementById('locationCountryName').value = city.country;
                    latitudeInput.value = city.latitude || '';
                    longitudeInput.value = city.longitude || '';
                    hideCityAutocomplete();
                }
            }
            
            function hideCityAutocomplete() {
                cityAutocomplete.classList.remove('visible');
                cityAutocomplete.innerHTML = '';
                citySuggestions = [];
                selectedCityIndex = -1;
            }
            
            cityInput.addEventListener('input', (e) => {
                searchCities(e.target.value);
            });
            
            cityInput.addEventListener('keydown', (e) => {
                const items = cityAutocomplete.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedCityIndex = Math.min(selectedCityIndex + 1, items.length - 1);
                    updateCitySelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedCityIndex = Math.max(selectedCityIndex - 1, 0);
                    updateCitySelection(items);
                } else if (e.key === 'Enter' && selectedCityIndex >= 0) {
                    e.preventDefault();
                    selectCity(selectedCityIndex);
                } else if (e.key === 'Escape') {
                    hideCityAutocomplete();
                }
            });
            
            function updateCitySelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedCityIndex);
                });
                if (selectedCityIndex >= 0 && items[selectedCityIndex]) {
                    items[selectedCityIndex].scrollIntoView({ block: 'nearest' });
                }
            }
            
            cityAutocomplete.addEventListener('click', (e) => {
                const item = e.target.closest('.autocomplete-item');
                if (item) {
                    selectCity(parseInt(item.dataset.index));
                }
            });
            
            // Hide autocomplete on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-wrapper')) {
                    hideCountryAutocomplete();
                    hideCityAutocomplete();
                }
            });
        })();
    </script>
</body>
</html>
